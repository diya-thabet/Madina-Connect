apiVersion: v1
kind: Secret
metadata:
  name: madina-secrets
type: Opaque
stringData:
  # üîí REPLACE THIS WITH YOUR REAL KEY
  GEMINI_API_KEY: ""

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: madina-config
data:
  # üåê Internal Service Discovery URLs
  # In K8s, services talk to each other via their Service Name
  # NOTE: Internal communication still uses the standard ports (8000, 8081, etc.)
  MOBILITY_SERVICE_URL: "http://mobility-service:8000"
  AIR_QUALITY_WSDL_URL: "http://air-quality-service:8081/ws/airQuality.wsdl"
  EVENTS_SERVICE_URL: "http://events-service:8082/graphql"

---
# üöå Service 1: Mobility (REST)
apiVersion: v1
kind: Service
metadata:
  name: mobility-service
spec:
  type: NodePort
  selector:
    app: mobility
  ports:
    - protocol: TCP
      port: 8000        # Internal port (inside cluster)
      targetPort: 8000  # Container port
      nodePort: 30000   # External access port (http://localhost:30000)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mobility-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mobility
  template:
    metadata:
      labels:
        app: mobility
    spec:
      containers:
        - name: mobility
          image: dhia2001/soc:mobility-service
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000

---
# ‚òÅÔ∏è Service 2: Air Quality (SOAP)
apiVersion: v1
kind: Service
metadata:
  name: air-quality-service
spec:
  type: NodePort
  selector:
    app: air-quality
  ports:
    - protocol: TCP
      port: 8081
      targetPort: 8080  # FIX: Spring Boot usually listens on 8080 inside
      nodePort: 30081   # External access port (http://localhost:30081)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: air-quality-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: air-quality
  template:
    metadata:
      labels:
        app: air-quality
    spec:
      containers:
        - name: air-quality
          image: dhia2001/soc:madina-soap
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080 # FIX: Reflected internal port change
          # FIX: Readiness Probe ensures we don't connect before Java is ready
          readinessProbe:
            tcpSocket:
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5

---
# üéâ Service 3: Events/Citizen (GraphQL)
apiVersion: v1
kind: Service
metadata:
  name: events-service
spec:
  type: NodePort
  selector:
    app: events
  ports:
    - protocol: TCP
      port: 8082
      targetPort: 8082
      nodePort: 30082   # External access port (http://localhost:30082)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: events-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: events
  template:
    metadata:
      labels:
        app: events
    spec:
      containers:
        - name: events
          image: dhia2001/soc:madina-citizen
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8082

---
# üß† Service 4: LLM Planner (Orchestrator)
apiVersion: v1
kind: Service
metadata:
  name: planner-service
spec:
  type: NodePort
  selector:
    app: planner
  ports:
    - protocol: TCP
      port: 8001
      targetPort: 8001
      nodePort: 30001   # External access port (http://localhost:30001)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: planner-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: planner
  template:
    metadata:
      labels:
        app: planner
    spec:
      containers:
        - name: planner
          image: dhia2001/madina-planner-llm:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8001
          envFrom:
            - configMapRef:
                name: madina-config
            - secretRef:
                name: madina-secrets

---
# üíª Service 5: Frontend (React)
# THIS IS THE NEW PART
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
spec:
  type: NodePort
  selector:
    app: frontend
  ports:
    - protocol: TCP
      port: 3000        # Internal port
      targetPort: 3000  # Container port (from server.js)
      nodePort: 30005   # External access URL: http://localhost:30005
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: frontend
          image: dhia2001/madina-frontend:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 3000
          env:
            # This tells server.js where to send /api requests
            - name: API_URL
              value: "http://planner-service:8001"